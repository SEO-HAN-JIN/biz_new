<!--<!DOCTYPE html>-->
<!--<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/framelayout}">-->


<th:block th:fragment="content">

    <div class="page-heading">
        <div class="page-title">
            <div class="row">
                <div class="col-12 col-md-6 order-md-1 order-last p-3">
                    <h3>Í≥†Í∞ùÍ¥ÄÎ¶¨</h3>
                </div>
                <div class="col-12 col-md-6 order-md-2 order-first">
                    <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">Í≥†Í∞ùÍ¥ÄÎ¶¨</li>
                            <li class="breadcrumb-item active" aria-current="page">Í≥†Í∞ùÍ¥ÄÎ¶¨</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>

        <section id="horizontal-input">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body pt-3 pb-3" id="searchForm">
<!--                            <div class="row align-items-center p-2" style="">-->
                            <div class="row align-items-center p-2 search-area custom-bg">
                                <div class="col-md-11">
                                    <div class="form-group row mb-0 align-items-center text-center">
                                        <label class="col-form-label col-lg-1 col-3">ÏÇ¨ÏóÖÏûêÎ≤àÌò∏</label>
                                        <div class="col-lg-2 col-9">
                                            <input type="text" id="search_bizNo" class="form-control form-control-sm" name="bizNo" placeholder="ÏÇ¨ÏóÖÏûêÎ≤àÌò∏">
                                        </div>
                                        <label class="col-form-label col-lg-1 col-3">Í≥†Í∞ùÎ™Ö</label>
                                        <div class="col-lg-2 col-9">
                                            <input type="text" id="search_custName" class="form-control form-control-sm" name="custName" placeholder="Í≥†Í∞ùÎ™Ö">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-1 text-end">
                                    <a href="#" class="btn btn-primary" id="searchBtn">Ï°∞Ìöå</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="row" id="basic-table">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Í≥†Í∞ùÍ¥ÄÎ¶¨Î™©Î°ù</h4>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-end" style="width: 100%;">
                                <div class="d-flex pb-3 gap-1">
                                    <button type="button" class="btn btn-primary btn-sm" id="modalAddBtn" data-bs-toggle="modal" data-bs-target="#customerModal">Ï∂îÍ∞Ä</button>

                                    <button type="button" class="btn btn-secondary btn-sm" id="btnDeleteCustomerGrid">ÏÇ≠Ï†ú</button>
                                </div>
                            </div>
                            <div id="customerGrid" class="tui-grid"></div>
                        </div>

                        <!-- Í≥†Í∞ù Ï†ïÎ≥¥ (ÌöåÏÇ¨ Ï†ïÎ≥¥ ÎîîÏûêÏù∏ Ï†ÅÏö©) Î™®Îã¨ -->
                        <div class="modal fade" id="customerModal" tabindex="-1" role="dialog" aria-labelledby="customerModalTitle" aria-hidden="true" data-bs-backdrop="static">
                            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
                                <div class="modal-content shadow-sm rounded-3 border-0">
                                    <div class="modal-header bg-primary text-white rounded-top">
                                        <h5 class="modal-title text-white mb-0" id="customerModalTitle">Í≥†Í∞ù Ï†ïÎ≥¥ Í¥ÄÎ¶¨</h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>

                                    <div class="card-body p-4">
                                        <form id="customerForm" class="form">
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-4">
                                                    <label for="bizNo" class="form-label">ÏÇ¨ÏóÖÏûêÎ≤àÌò∏</label>
                                                    <input type="text" id="bizNo" class="form-control" placeholder="ÏÇ¨ÏóÖÏûêÎ≤àÌò∏" name="bizNo">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="custName" class="form-label">Í≥†Í∞ùÎ™Ö</label>
                                                    <input type="text" id="custName" class="form-control" placeholder="Í≥†Í∞ùÎ™Ö" name="custName">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="ownerName" class="form-label">ÎåÄÌëúÏûêÏÑ±Î™Ö</label>
                                                    <input type="text" id="ownerName" class="form-control" placeholder="ÎåÄÌëúÏûêÏÑ±Î™Ö" name="ownerName">
                                                </div>
                                            </div>
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-4">
                                                    <label for="custTel" class="form-label">Ïó∞ÎùΩÏ≤ò</label>
                                                    <input type="text" id="custTel" class="form-control" name="custTel" placeholder="Ïó∞ÎùΩÏ≤ò">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="custMail" class="form-label">Ïù¥Î©îÏùº</label>
                                                    <input type="email" id="custMail" class="form-control" placeholder="Ïù¥Î©îÏùº" name="custMail">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="depositorName" class="form-label">ÏûÖÍ∏àÏûêÎ™Ö</label>
                                                    <input type="text" id="depositorName" class="form-control" name="depositorName" placeholder="ÏûÖÍ∏àÏûêÎ™Ö">
                                                </div>
                                            </div>
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-4">
                                                    <label for="mileage" class="form-label">ÎßàÏùºÎ¶¨ÏßÄ ÎàÑÏ†ÅÍ∏àÏï°</label>
                                                    <input type="text" id="mileage" class="form-control" name="mileage" placeholder="ÎßàÏùºÎ¶¨ÏßÄ ÎàÑÏ†ÅÍ∏àÏï°">
                                                    <input type="hidden" id="mileagePrev" class="form-control" name="mileagePrev">
                                                </div>
                                                <div class="col-md-4" id="incentiveDiv">
                                                    <label for="incentiveRate" class="form-label">Ïù∏ÏÑºÌã∞Î∏åÏú®</label>
                                                    <input type="number" id="incentiveRate" class="form-control" name="incentiveRate" placeholder="Ïù∏ÏÑºÌã∞Î∏åÏú®" step="0.1" min="0" max="99.9">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="useInd" class="form-label">ÏÇ¨Ïö©Ïó¨Î∂Ä</label>
                                                    <select class="form-select" id="useInd" name="useInd"></select>
                                                </div>
                                            </div>
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-4">
                                                    <label for="bizType" class="form-label">ÏóÖÌÉú</label>
                                                    <input type="text" class="form-control" id="bizType" name="bizType" placeholder="ÏóÖÌÉú ÏûÖÎ†•">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="bizClass" class="form-label">Ï¢ÖÎ™©</label>
                                                    <input type="text" class="form-control" id="bizClass" name="bizClass" placeholder="Ï¢ÖÎ™© ÏûÖÎ†•">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="regDate" class="form-label">Îì±Î°ùÏùºÏûê</label>
                                                    <input type="text" id="regDate" class="form-control" name="regDate" placeholder="Îì±Î°ùÏùºÏûê" disabled>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="custAddr" class="form-label">Ï£ºÏÜå</label>
                                                <input type="text" id="custAddr" class="form-control" name="custAddr" placeholder="Ï£ºÏÜå">
                                            </div>
                                        </form>
                                    </div>

                                    <div class="modal-footer bg-light rounded-bottom d-flex justify-content-end">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                            Îã´Í∏∞
                                        </button>
                                        <button type="button" class="btn btn-success ms-2" id="modalSaveBtn">
                                            üíæ Ï†ÄÏû•
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </section>
    </div>
    <script th:inline="javascript">
        (function() {
        const apiUrl = '/api/pages/customer';

        let customerGrid;
        let $isNew = 'N';

        let isAdmin;

        $(document).ready(function() {

            const roleIds = /*[[${roleIds}]]*/'';
            const adminRoles = ['1', '2'];  // ÏäàÌçºÍ¥ÄÎ¶¨Ïûê(1), Í¥ÄÎ¶¨Ïûê(2)
            isAdmin = adminRoles.some(value => roleIds.includes(value));

            if (!isAdmin) {
                $("#btnDeleteCustomerGrid").hide();
            }

            initEvent();
            findInitCodes();

            $("#custTel").on('input', formatPhoneNumber);
            $("#mileage").on('input', formatCurrency);
        });

        const findInitCodes = async () => {
            const param =
                [
                    {"patternCode": "SE06"}
                ];

            const result = await CommonJs.initFindCodes(param);
            findCodeCallback(result);
        }

        const findCodeCallback = (result) => {
            const SE06Options = {
                value: 'baseCode',
                text: 'codeName',
                items: result.SE06,
                placeholder: 'ÏÑ†ÌÉù'
            };
            $("#useInd").addOptions(SE06Options);

            initCustomerGrid();
        }

        const initEvent = () => {

            $("#btnDeleteCustomerGrid").on('click', fn_deleteCustomerGrid);

            $('#modalAddBtn').on('click', () => {openPgmModal('1')});
            $('#customerModal').off('hide.bs.modal').on('hide.bs.modal', closeBeforeModal);  // Î™®Îã¨Ïù¥ Îã´ÌûàÍ∏∞ Ï†ÑÏóê Ïù¥Î≤§Ìä∏ Î∞úÏÉù
            $('#exampleModalCenter').off('hidden.bs.modal').on('hidden.bs.modal', closeAfterModal); // Î™®Îã¨Ïù¥ ÏôÑÏ†ÑÌûà Îã´Ìûå ÌõÑ Ïù¥Î≤§Ìä∏ Î∞úÏÉù
            $("#modalSaveBtn").on('click', fn_saveCustomerGrid);

            $("#searchBtn").on('click', searchCustomerGrid);
        }

        const initCustomerGrid = () => {

            var columns = new CustomTuiGrid()
                .add('bizNo', 'ÏÇ¨ÏóÖÏûêÎ≤àÌò∏', 200, {})
                .add('custName', 'Í≥†Í∞ùÎ™Ö', 130, {})
                .add('ownerName', 'ÎåÄÌëúÏûêÏÑ±Î™Ö', 150, { align: 'center' })
                .add('custAddr', 'Ï£ºÏÜå', 300, { align: 'center' })
                .add('custTel', 'Ïó∞ÎùΩÏ≤ò', 150, { align: 'center' })
                .add('custMail', 'Ïù¥Î©îÏùº', 150, { align: 'center' })
                .add('depositorName', 'ÏûÖÍ∏àÏûêÎ™Ö', 130, { align: 'center' })
                .addNumber('mileage', 'ÎßàÏùºÎ¶¨ÏßÄ', 130, {
                    align: 'right',
                    comma: true,
                    visible:isAdmin
                })
                .add('incentiveRate', 'Ïù∏ÏÑºÌã∞Î∏åÏú®', 150, { align: 'right', visible:isAdmin })
                .add('useInd', 'ÏÇ¨Ïö©Ïó¨Î∂Ä', 130, { align: 'center' })
                .addDate('regDate', 'Îì±Î°ùÏùºÏûê', 140, { align: 'center' })
                .setFitStyle('fill')  // ÌéòÏù¥ÏßÄ Ìè≠Ïóê ÎßûÏ∂îÏñ¥ Í∑∏Î¶¨ÎìúÎ•º Ï±ÑÏö∞Í∏∞
            ;

            customerGrid = columns.init('customerGrid', [])
                .render();

            // ÎçîÎ∏î ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
            customerGrid.getGrid().on('dblclick', function(ev) {
                openPgmModal('2');
            });

            searchCustomerGrid();
        }

        const searchCustomerGrid = () => {
            customerGrid.clear();

            let $bizNo = $('#search_bizNo').val();
            let $empName = $('#search_empName').val();
            let $custName = $('#search_custName').val();

            const param = {
                bizNo : $bizNo,
                empName : $empName,
                custName : $custName
            };

            $.ajax({
                url: apiUrl,
                data: param,
                type: 'GET',
                success: (result) => {
                    customerGrid.bind(result);
                }
            });
        }

        const fn_saveCustomerGrid = () => {

            const param = {};
            $('#customerModal').find('input, select, input[type="checkbox"]').each((index, item) => {
                // checkboxÏùº Îïå
                if ($(item).is(':checkbox')) {
                    param[item.id] = $(item).prop('checked') ? 'Y' : 'N'; // Ï≤¥ÌÅ¨ Ïó¨Î∂ÄÏóê Îî∞Îùº Y ÎòêÎäî N ÏÑ§Ï†ï
                } else if (item.id === 'mileage') {
                    param[item.id] = item.value.replace(',', ''); // input Í∞í ÏÑ§Ï†ï
                } else{
                    // inputÏùº ÎïåÏùò Ï≤òÎ¶¨
                    param[item.id] = item.value; // input Í∞í ÏÑ§Ï†ï
                }
            });

            param.isNew = $isNew;

            if (isNull(param.bizNo)) {
                alert("ÏÇ¨ÏóÖÏûêÎ≤àÌò∏Îäî ÌïÑÏàò Í∞í ÏûÖÎãàÎã§.");
                return false;
            }

            if (!isNull(param.custMail) && !isValidEmail(param.custMail)) {
                alert("Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ïù¥Î©îÏùº ÌòïÏãùÏûÖÎãàÎã§.");
                return false;
            }

            if (confirm("Îç∞Ïù¥ÌÑ∞Î•º Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                $.ajax({
                    url: apiUrl,
                    data: JSON.stringify(param),
                    contentType:'application/json',
                    type: 'POST',
                    success: (result) => {
                        if (result > 0) {
                            alert("Ï†ÄÏû•Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.");
                            $('#customerModal').modal('hide');
                            searchCustomerGrid();
                        } else {
                            alert("Ï†ÄÏû•Ïóê Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§.");
                            searchCustomerGrid();
                        }
                    },error: (xhr, status, error) => {
                        alert(xhr.responseText);
                    }
                })
            }
        }

        const fn_deleteCustomerGrid = () => {
            const focusedCell = customerGrid.getGrid().getFocusedCell();
            if (isNull(focusedCell)) {
                alert("ÏÇ≠Ï†úÌï† ÌñâÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                return;
            }

            const confirmResult = confirm("ÏÑ†ÌÉùÌïú ÌñâÏùò Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?");
            if (confirmResult) {
                const focusRow = customerGrid.getGrid().getRow(focusedCell.rowKey);
                let params = {
                    bizNo : focusRow.bizNo,
                    empId: focusRow.empId,
                }
                $.ajax({
                    url: apiUrl,
                    data: JSON.stringify(params),
                    contentType:'application/json',
                    type: 'DELETE',
                    success: (result) => {
                        if (result > 0) {
                            alert("ÏÇ≠Ï†úÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.");
                            searchCustomerGrid();
                        } else {
                            alert("ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§.");
                            searchCustomerGrid();
                        }
                    }
                })
            }
        }

        const openPgmModal = (param) => {
            if (param === '1') {
                $isNew = true;
            } else {
                $isNew = false;
            }
            clearForm('customerModal');

            if(!isAdmin)
            {
                $("#incentiveDiv").hide();
                $("#mileage").attr('disabled', true);
            }
            else {
                $("#incentiveDiv").show();
                $("#mileage").attr('disabled', false);
            }


            // Ï∂îÍ∞Ä Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú
            if (param === '2') {
                const focusedCell = customerGrid.getGrid().getFocusedCell();
                const focusedData = customerGrid.getGrid().getRow(focusedCell.rowKey);

                $('#customerModal').find('input, select, textarea').each(function() {
                    const fieldId = $(this).attr('id');
                    if (fieldId && focusedData[fieldId] !== undefined) {
                        if ($(this).is(':checkbox')) {
                            // Ï≤¥ÌÅ¨Î∞ïÏä§Îäî 'Y', 'N' ÎòêÎäî true/falseÎ°ú Í∞íÏùÑ Î∞îÏù∏Îî©
                            $(this).prop('checked', focusedData[fieldId] === 'Y' || focusedData[fieldId] === true);
                        } else if ($(this).is('select')) {
                            $(this).val(focusedData[fieldId]);
                        } else if (fieldId === 'mileage') {
                            $("#mileagePrev").val(focusedData[fieldId]);
                            const replaceNumber = formatToCurrency(focusedData[fieldId]);
                            $(this).val(replaceNumber);
                        } else {
                            // Í∑∏ Ïô∏ input, textareaÎäî Í∞í Î∞îÏù∏Îî©
                            $(this).val(focusedData[fieldId]);
                        }
                    }
                });

                $('#bizNo').attr('disabled', true);
            } else {
                $('#bizNo').attr('disabled', false);
            }

            $('#customerModal').modal('show');
        }

        const closeBeforeModal = () => {
            $('#customerModal').find('input, select, textarea').each(function() {
                if ($(this).is(':checkbox')) {
                    // Ï≤¥ÌÅ¨Î∞ïÏä§Îäî falseÎ°ú ÏÑ§Ï†ï
                    $(this).prop('checked', false);
                } else {
                    // Í∑∏ Ïô∏Ïùò ÏûÖÎ†• ÌïÑÎìúÎäî Îπà Î¨∏ÏûêÏó¥Î°ú ÏÑ§Ï†ï
                    $(this).val('');
                }
            });
        }

        const closeAfterModal = () => {
            console.log('Î™®Îã¨Ïù¥ Îã´ÌòîÏäµÎãàÎã§!');
        }

        const clearForm = (id) => {
            $('#' + id).find('input, select, textarea').each(function() {
                if ($(this).is(':checkbox')) {
                    // Ï≤¥ÌÅ¨Î∞ïÏä§Îäî falseÎ°ú ÏÑ§Ï†ï
                    $(this).prop('checked', false);
                } else {
                    // Í∑∏ Ïô∏Ïùò ÏûÖÎ†• ÌïÑÎìúÎäî Îπà Î¨∏ÏûêÏó¥Î°ú ÏÑ§Ï†ï
                    $(this).val('');
                }
            });
        }

        const bindForm = (id) => {
            $('#' + id).find('input, select, textarea').each(function() {
                const fieldId = $(this).attr('id');
                if (fieldId && focusedData[fieldId] !== undefined) {
                    if ($(this).is(':checkbox')) {
                        // Ï≤¥ÌÅ¨Î∞ïÏä§Îäî 'Y', 'N' ÎòêÎäî true/falseÎ°ú Í∞íÏùÑ Î∞îÏù∏Îî©
                        $(this).prop('checked', focusedData[fieldId] === 'Y' || data[fieldId] === true);
                    } else if ($(this).is('select')) {
                        // select Î∞ïÏä§Îäî Ìï¥Îãπ valueÏôÄ ÏùºÏπòÌïòÎäî optionÏùÑ ÏÑ†ÌÉù
                        $(this).val(focusedData[fieldId]).trigger('change'); // trigger('change')Îäî select Î∞ïÏä§Ïùò Î≥ÄÌôîÎ•º Î∞òÏòÅ
                    } else {
                        // Í∑∏ Ïô∏ input, textareaÎäî Í∞í Î∞îÏù∏Îî©
                        $(this).val(focusedData[fieldId]);
                    }
                }
            });
        }

        function formatPhoneNumber() {
            let value = $(this).val().replace(/[^0-9]/g, ''); // Ïà´Ïûê Ïù¥Ïô∏Ïùò Î¨∏ÏûêÎäî Ï†úÍ±∞

            if (value.length < 4) {
                $(this).val(value);
            } else if (value.length < 8) {
                $(this).val(value.slice(0, 3) + '-' + value.slice(3));
            } else {
                $(this).val(value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11));
            }
        }

        function formatCurrency() {
            // ÌòÑÏû¨ ÏûÖÎ†• Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
            let value = $(this).val();

            // Ïà´Ïûê Ïù¥Ïô∏Ïùò Î¨∏Ïûê Ï†úÍ±∞
            value = value.replace(/[^0-9]/g, '');

            // Ï≤ú Îã®ÏúÑÎ°ú ÏΩ§Îßà Ï∂îÍ∞Ä
            if (value) {
                value = Number(value).toLocaleString();  // ÏΩ§Îßà Ï∂îÍ∞Ä
            }

            // Ìè¨Îß∑ÌåÖÎêú Í∞íÏùÑ ÏûÖÎ†• ÌïÑÎìúÏóê ÏÑ§Ï†ï
            $(this).val(value);
        }
        })();
    </script>
</th:block>