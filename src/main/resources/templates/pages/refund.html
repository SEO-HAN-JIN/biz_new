<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/framelayout}">


<div layout:fragment="content">

    <div class="page-heading">
        <div class="page-title">
            <div class="row">
                <div class="col-12 col-md-6 order-md-1 order-last p-3">
                    <h3>환불관리</h3>
                </div>
                <div class="col-12 col-md-6 order-md-2 order-first">
                    <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">정산관리</li>
                            <li class="breadcrumb-item active" aria-current="page">환불요청</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>

        <section id="horizontal-input">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body pt-3 pb-3" id="searchForm">
                            <!--                            <div class="row align-items-center p-2" style="">-->
                            <div class="row align-items-center p-2 search-area custom-bg">
                                <div class="col-md-11">
                                    <div class="form-group row mb-0 align-items-center text-center">
                                        <label class="col-form-label col-lg-1 col-3">날짜</label>
                                        <div class="col-lg-3 col-9">
                                            <div class="d-flex">
                                                <input type="date" class="form-control form-control-sm me-2" id="searchStartDate" >
                                                <input type="date" class="form-control form-control-sm" id="searchEndDate" >
                                            </div>
                                        </div>
                                        <label class="col-form-label col-lg-1 col-3">고객명</label>
                                        <div class="col-lg-2 col-9">
                                            <input type="text" id="custName" class="form-control form-control-sm" name="fname" placeholder="메뉴명">
                                        </div>
                                        <label class="col-form-label col-lg-1 col-3">상품명</label>
                                        <div class="col-lg-2 col-9">
                                            <input type="text" id="prodName" class="form-control form-control-sm" name="fname" placeholder="메뉴명">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-1 text-end">
                                    <a href="#" class="btn btn-primary cursor-auto" id="searchBtn">조회</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="row" id="basic-table">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">환불신청내역</h4>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-end" style="width: 100%;">
                                <div class="d-flex pb-3 gap-1">
                                    <button type="button" class="btn btn-primary btn-m" id="modalAddBtn" data-bs-toggle="modal" data-bs-target="#refundModal">추가</button>

                                    <button type="button" class="btn btn-secondary btn-m" id="btnDeletePaymentGrid">삭제</button>
                                </div>
                            </div>
                            <div id="paymentGrid" class="tui-grid"></div>
                        </div>

                        <div class="modal fade" id="refundModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" data-bs-backdrop="static">
                            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
                                <div class="modal-content">
                                    <!-- Modal Header -->
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title text-white" id="exampleModalCenterTitle">환불요청 상세정보</h5>
                                        <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>

                                    <!-- Modal Body -->
                                    <div class="modal-body">
                                        <!-- 정산요청 정보섹션 -->
                                        <fieldset class="border p-3 rounded">
                                            <legend class="float-none w-auto px-2">정산요청 정보</legend>
                                            <div class="refundModal paymentDetail">
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label class="form-label">정산번호</label>
                                                            <div class="d-flex align-items-center">
                                                                <input type="text" id="_refundModal_settlementSeq" class="form-control me-2" name="settlementSeq" disabled>
                                                                <button id="_refundModal_applyPaymentBtn" type="button" class="btn icon btn-outline-dark">
                                                                    <i class="bi bi-search"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">담당자</label>
                                                            <input type="text" id="_refundModal_empName" class="form-control" name="empName" disabled>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">고객</label>
                                                            <input type="text" id="_refundModal_custName" class="form-control" name="custName" disabled>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row g-3">
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">작업시작일</label>
                                                            <input type="date" id="_refundModal_dateWorkFrom" class="form-control" name="dateWorkFrom" disabled>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">작업종료일</label>
                                                            <input type="date" id="_refundModal_dateWorkTo" class="form-control" name="dateWorkTo" disabled>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">작업일수</label>
                                                            <input type="number" id="_refundModal_workDay" class="form-control" name="workDay" disabled>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">유입수</label>
                                                            <input type="text" id="_refundModal_inflowCnt" class="form-control" name="inflowCnt" disabled>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row g-3">
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">상품</label>
                                                            <input type="text" id="_refundModal_prodName" class="form-control" name="prodName" disabled>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">상품가</label>
                                                            <input type="text" id="_refundModal_prodAmt" class="form-control is-num text-end" name="prodAmt" disabled>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">판매가</label>
                                                            <input type="text" id="_refundModal_saleAmt" class="form-control is-num text-end" name="saleAmt" disabled>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">판매총액</label>
                                                            <input type="text" id="_refundModal_saleTotalAmt" class="form-control is-num text-end" name="saleTotalAmt" disabled>
                                                        </div>
                                                    </div>
                                                    <input type="hidden" id="_refundModal_incentiveRate" name="incentiveRate">
                                                    <input type="hidden" id="_refundModal_custId" name="custId">
                                                    <input type="hidden" id="_refundModal_prodId" name="prodId">
                                                    <input type="hidden" id="_refundModal_userId" name="userId">
                                                </div>
                                            </div>
                                        </fieldset>

                                        <!-- 정산 정보 섹션 -->
                                        <fieldset class="border p-3 rounded mt-4">
                                            <legend class="float-none w-auto px-2">환불요청 정보</legend>
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <div class="form-group">
                                                        <label class="form-label">환불요청일</label>
                                                        <input type="date" id="_refundModal_refundDateWorkTo" class="form-control" name="refundDateWorkTo">
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="form-group">
                                                        <label class="form-label">환불일수</label>
                                                        <input type="number" id="_refundModal_refundWorkDay" class="form-control" name="refundWorkDay" disabled>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="form-group">
                                                        <label class="form-label">환불금액</label>
                                                        <input type="text" id="_refundModal_refundExpectAmt" class="form-control is-num text-end" name="refundExpectAmt" disabled>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="form-group">
                                                        <label class="form-label">환불수수료</label>
                                                        <input type="text" id="_refundModal_refundExpectRateAmt" class="form-control is-num text-end" name="refundExpectRateAmt" disabled>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <div class="form-group">
                                                        <label class="form-label">환불구분</label>
                                                        <select id="_refundModal_refundGubun" class="form-select form-control-sm" name="refundGubun">
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <input type="hidden" id="_refundModal_refundSaleTotalAmt" name="refundSaleTotalAmt">
                                        </fieldset>
                                    </div>

                                    <!-- Modal Footer -->
                                    <div class="modal-footer bg-light">
                                        <button type="button" class="btn btn-light-secondary" data-bs-dismiss="modal">
                                            <i class="bx bx-x"></i> 닫기
                                        </button>
                                        <button type="button" class="btn btn-primary ms-1" id="_refundModal_btnSave">
                                            <i class="bx bx-check"></i> 저장
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="modal fade" id="paymentModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" data-bs-backdrop="static">
                            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
                                <div class="modal-content">
                                    <!-- Modal Header -->
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title text-white" id="paymentModalTitle">정산요청내역</h5>
                                        <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>

                                    <section id="horizontal-input-modal">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div id="searchTable" class="table">
                                                    <div class="card-body pt-3 pb-3" id="modalSearchForm">
                                                        <div id="_paymentModal_searchTable">
                                                            <div class="row align-items-center p-2 search-area custom-bg">
                                                                <div class="col-md-10">
                                                                    <div class="form-group row mb-0 align-items-center text-center">
                                                                        <!-- 정산신청일 -->
                                                                        <div class="col-md-3 text-start">
                                                                            <label class="col-form-label">정산요청일</label>
                                                                        </div>
                                                                        <div class="col-md-5">
                                                                            <div class="d-flex justify-content-between">
                                                                                <input type="date" class="form-control form-control-sm me-2" id="_paymentModal_searchStartDate" name="searchStartDate">
                                                                                <input type="date" class="form-control form-control-sm" id="_paymentModal_searchEndDate" name="searchEndDate" >
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <!-- 조회 버튼 -->
                                                                <div class="col-md-2 text-end">
                                                                    <a href="#" class="btn btn-primary" id="_paymentModal_searchBtn">조회</a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </section>

                                    <!-- Modal Body -->
                                    <div class="modal-body">
                                        <h6>정산요청목록</h6>
                                        <div id="paymentModalGrid" style="height: 450px"></div>
                                    </div>

                                    <!-- Modal Footer -->
                                    <div class="modal-footer bg-light">
                                        <button type="button" class="btn btn-light-secondary" data-bs-dismiss="modal">
                                            <i class="bx bx-x"></i> 닫기
                                        </button>
                                        <button type="button" class="btn btn-primary ms-1" id="_paymentModal_applyBtn">
                                            <i class="bx bx-check"></i> 적용
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </section>
    </div>
    <script type="text/javascript">

        const apiUrl = '/api/pages/refund';

        let paymentGrid;
        let paymentModalGrid;
        let $isNew = 'N';
        let paymentModalPrefix = '_paymentModal_';
        let refundModalPrefix = '_refundModal_';

        $(document).ready(function() {

            findInitCodes();

            const nowYear = new Date().getFullYear();
            const nowMonth = new Date().getMonth();

            const startDate = new Date(nowYear, nowMonth, 1); // 당월 1일
            const endDate = new Date(nowYear, nowMonth + 1, 0); // 현재 달의 마지막 날

            // 포맷팅된 날짜 값을 input에 설정
            $("#searchStartDate").val(formatDate(startDate));
            $("#searchEndDate").val(formatDate(endDate));


            $("#_paymentModal_searchStartDate").val(formatDate(startDate));
            $("#_paymentModal_searchEndDate").val(formatDate(endDate));

            initEvent();
            initPaymentGrid();
            initPaymentModalGrid();
        });

        const findInitCodes = async () => {
            const param =
                [
                    {"patternCode": "SE03"}
                ];

            const result = await CommonJs.initFindCodes(param);
            findCodeCallback(result);
        }

        const findCodeCallback = (result) => {
            const options = {
                value: 'baseCode',
                text: 'codeName',
                items: result.SE03,
                placeholder: '선택'
            };
            $("#" + refundModalPrefix + "refundGubun").addOptions(options);
        }

        const initEvent = () => {
            $("#modalAddBtn").on('click', function() {
                openPgmModal('1')
            });

            $("#searchBtn").on('click', searchPaymentGrid);

            $("#" + refundModalPrefix + "applyPaymentBtn").on('click', openPaymentModal);

            $("#" + paymentModalPrefix + "applyBtn").on('click', applyPaymentModal);
            $("#" + paymentModalPrefix + "searchBtn").on('click', searchPaymentModalGrid);

            $("#" + refundModalPrefix + "refundDateWorkTo").on('change', validRefundDateWorkTo);
            $("#" + refundModalPrefix + "btnSave").on('click', saveRefund);
        }


        function selectKeepInd(obj) {

            var keepInd = obj.checked;

            var inputElement = $("#custKeepUseAmt");

            if (keepInd) {
                // Enable the element
                $(inputElement).prop("disabled", false);
            } else {
                // Disable the element
                $(inputElement).prop("disabled", true);
            }
        }

        const validRefundDateWorkTo = () => {
            const d1 = $("#" + refundModalPrefix + "dateWorkTo").val();
            const d2 = $("#" + refundModalPrefix + "refundDateWorkTo").val();
            const d3 = $("#" + refundModalPrefix + "dateWorkFrom").val();

            const date1 = new Date(d1); // 정산-작업종료일
            const date2 = new Date(d2); // 환불-요청일
            const date3 = new Date(d3); // 정산-작업시작일

            if (date1.getTime() < date2.getTime() || date3.getTime() > date2.getTime() ) {
                alert("환불요청일은 정산요청의 작업시작일과 작업종료일 사이어야 합니다.");
                $("#" + refundModalPrefix + "refundDateWorkTo").val('');
                $("#" + refundModalPrefix + "refundWorkDay").val('');
                $("#" + refundModalPrefix + "refundExpectAmt").val('');
                $("#" + refundModalPrefix + "refundExpectRateAmt").val('');
                return;
            }

            setRefundWorkDay();
        }

        const setRefundWorkDay = () => {

            const d1 = $("#" + refundModalPrefix + "dateWorkTo").val();
            const d2 = $("#" + refundModalPrefix + "refundDateWorkTo").val();

            const date1 = new Date(d1);
            const date2 = new Date(d2);

            const diffDate = date1.getTime() - date2.getTime();

            $("#" + refundModalPrefix + "refundWorkDay").val(Math.abs(diffDate / (1000 * 60 * 60 * 24)) + 1);

            saleSum();
        }

        function saleSum() {
            var saleAmt = isNull($("#" + refundModalPrefix + "saleAmt").val()) ? 0 : parseInt($("#" + refundModalPrefix + "saleAmt").val());          // 판매가
            var prodAmt = isNull($("#" + refundModalPrefix + "prodAmt").val()) ? 0 : parseInt($("#" + refundModalPrefix + "prodAmt").val());          // 상품가(공급가)
            var inflowCnt = isNull($("#" + refundModalPrefix + "inflowCnt").val()) ? 0 : parseInt($("#" + refundModalPrefix + "inflowCnt").val());    // 유입수
            var workDay = isNull($("#" + refundModalPrefix + "refundWorkDay").val()) ? 0 : parseInt($("#" + refundModalPrefix + "refundWorkDay").val());          // 환불일수
            var incentiveRate = isNull($("#" + refundModalPrefix + "incentiveRate").val()) ? 0 : parseFloat($("#" + refundModalPrefix + "incentiveRate").val());    // 직원인센티브율

            // 판매총액 (판매가 * 유입수 * 작업일)
            const saleTotalAmt = Math.floor(saleAmt * inflowCnt * workDay);

            // 환불금액 (상품가 * 유입수 * 환불일수)
            const expectAmt = Math.floor(prodAmt * inflowCnt * workDay);

            // 영업이익
            var costAmt = saleTotalAmt - expectAmt;

            // 환불수수료 : 소수점 제외하고 정수만 출력
            var expectRateAmt = Math.floor(costAmt * incentiveRate);
            console.log("## saleTotalAmt ##", saleTotalAmt);
            console.log("## expectAmt ##", expectAmt);
            console.log("## expectRateAmt ##", expectRateAmt);

            $("#" + refundModalPrefix + "refundSaleTotalAmt").val(saleTotalAmt);                    // 판매총액
            $("#" + refundModalPrefix + "refundExpectAmt").val(formatNumber(expectAmt));            // 환불금액
            $("#" + refundModalPrefix + "refundExpectRateAmt").val(formatNumber(expectRateAmt));    // 환불수수료
        }


        const initPaymentGrid = () => {

            var columns = new CustomTuiGrid()
                .setFitStyle('fill')  // 페이지 폭에 맞추어 그리드를 채우기
                .add('refundSettlementSeq', '환불번호', 250, {})
                .add('settlementSeq', '정산번호', 250, {})
                .add('empName', '담당자', 150, {})
                .add('custName', '고객명', 150, {})
                .add('prodName', '상품명', 200, { align: 'center' })
                .add('prodAmt', '상품가', 150, { align: 'right'})
                .add('saleAmt', '판매가', 120, { align: 'right' })
                .add('inflowCnt', '유입수', 120, {})
                .addDate('dateWorkFrom', '작업시작일', 150, {})
                .addDate('dateWorkTo', '작업종료일', 150, {})
                .addDate('refundDateWorkTo', '환불요청일', 150, {})
                .add('refundWorkDay', '환불일수', 120, {})
                .addNumber('refundSaleTotalAmt', '판매총액', 200, {
                    align: 'right',
                    textColor: 'red',
                    comma: true,
                    summary: {
                        template: valueMap => `합계: ${valueMap.sum.toLocaleString()}`
                    }})
                .addNumber('expectAmt', '환불금액', 200, {
                    align: 'right',
                    textColor: 'red',
                    comma: true,
                    summary: {
                        template: valueMap => `${valueMap.sum.toLocaleString()}`
                    }})
                .addNumber('expectRateAmt', '환불수수료', 200, {
                    align: 'right',
                    textColor: 'red',
                    comma: true,
                    summary: {
                        template: valueMap => `${valueMap.sum.toLocaleString()}`
                    }})
                .add('refundGubunName', '환불구분', 150, {})
                .add('statusName', '진행상태', 150, {})
                .add('workDay', '작업일수', 'auto', {visible: false})
                .add('saleTotalAmt', '판매총액', 'auto', {visible: false})
                .add('refundGubun', '환불구분', 'auto', {visible: false})

            paymentGrid = columns.init('paymentGrid', [])
                .render();

            // 더블 클릭 이벤트 설정
            paymentGrid.getGrid().on('dblclick', function(ev) {
                openPgmModal('2');
            });

            searchPaymentGrid();
        }

        const initPaymentModalGrid = () => {
            var columns = new CustomTuiGrid()
                .setFitStyle('fill')  // 페이지 폭에 맞추어 그리드를 채우기
                .add('settlementSeq', '정산번호', 250, {})
                .add('empName', '담당자', 150, {})
                .add('custName', '고객명', 250, {})
                .add('prodName', '상품명', 200, { align: 'center' })
                .addDate('dateWorkFrom', '작업시작일', 150, {})
                .addDate('dateWorkTo', '작업종료일', 150, {})
                .addDate('workDay', '작업일수', 150, {})
                .add('statusName', '진행상태', 150, {visible: false})
                .add('prodAmt', '상품가', 150, {visible: false})
                .add('saleAmt', '판매가', 120, {visible: false})
                .add('inflowCnt', '유입수', 120, {visible: false})
                .addNumber('saleTotalAmt', '판매총액', 200, {visible: false})
                .addNumber('depositRealAmt', '실제입금액', 200, {visible: false})
                .add('incentiveRate', '직원인센티브율', 200, {visible: false})

            paymentModalGrid = columns.init('paymentModalGrid', [])
                .render();

            // 더블 클릭 이벤트 설정
            paymentModalGrid.getGrid().on('dblclick', function(ev) {
                applyPaymentModal();
            });
        }

        const searchPaymentGrid = () => {
            paymentGrid.clear();

            const param = {
                menuNm : $("#first-name").val()
            };

            $.ajax({
                url: apiUrl,
                data: param,
                type: 'GET',
                success: (result) => {

                    if(result.length > 0) {
                        paymentGrid.bind(result);
                    }
                }
            });
        }

        const openPgmModal = (param) => {

            if (param === '1') {
                $isNew = true;
                $("#_refundModal_applyPaymentBtn").attr('disabled', false);
            } else {
                $isNew = false;
                $("#_refundModal_applyPaymentBtn").attr('disabled', true);
            }

            clearForm('refundModal');

            // 추가 버튼 클릭 시
            if (param === '2') {
                const focusedCell = paymentGrid.getGrid().getFocusedCell();
                const focusedData = paymentGrid.getGrid().getRow(focusedCell.rowKey);
                console.log("## focusedData ##", focusedData);

                $("#_refundModal_settlementSeq").val(focusedData.settlementSeq);
                $("#_refundModal_empName").val(focusedData.empName);
                $("#_refundModal_custName").val(focusedData.custName);
                $("#_refundModal_dateWorkFrom").val(focusedData.dateWorkFrom);
                $("#_refundModal_dateWorkTo").val(focusedData.dateWorkTo);
                $("#_refundModal_workDay").val(focusedData.workDay);
                $("#_refundModal_inflowCnt").val(focusedData.inflowCnt);
                $("#_refundModal_prodName").val(focusedData.prodName);
                $("#_refundModal_prodAmt").val(focusedData.prodAmt);
                $("#_refundModal_saleAmt").val(focusedData.saleAmt);
                $("#_refundModal_saleTotalAmt").val(focusedData.saleTotalAmt);
                $("#_refundModal_refundDateWorkTo").val(focusedData.refundDateWorkTo);
                $("#_refundModal_refundWorkDay").val(focusedData.refundWorkDay);
                $("#_refundModal_refundExpectAmt").val(focusedData.expectAmt);
                $("#_refundModal_refundExpectRateAmt").val(focusedData.expectRateAmt);
                $("#_refundModal_refundGubun").val(focusedData.refundGubun);
            }

            $('#refundModal').modal('show');

        }

        const clearForm = (id) => {
            $('#' + id).find('input, select, textarea').each(function () {
                if ($(this).is(':checkbox')) {
                    // 체크박스는 체크 해제
                    $(this).prop('checked', false);
                } else if ($(this).is('select')) {
                    const obj = this;
                    if (obj.classList.contains('choices') && obj.choicesInstance) {
                        // Choices.js가 적용된 select 초기화
                        obj.choicesInstance.setChoiceByValue(''); // 선택값 초기화
                    } else {
                        // 일반 select는 첫 번째 값으로 초기화
                        $(this).val($(this).find('option:first').val());
                    }
                } else {
                    // 나머지 input 및 textarea는 빈 값으로 초기화
                    $(this).val('');
                }
            });
        };


        const saveRefund = () => {
            const param = {};
            $('#refundModal').find('input, select, input[type="checkbox"]').each((index, item) => {
                // checkbox일 때
                if ($(item).is(':checkbox')) {
                    param[item.name] = $(item).prop('checked') ? 'Y' : 'N'; // 체크 여부에 따라 Y 또는 N 설정
                } else {
                    // input일 때의 처리
                    param[item.name] = item.value.replace(/,/g, ''); // input 값 설정
                }
            });

            console.log("## param ##", param);
            if(isNull(param.refundDateWorkTo))
            {
                alert("환불요청일을 입력해주세요.");
                return false;
            }

            if(isNull(param.refundGubun))
            {
                alert("환불구분을 입력해주세요.");
                return false;
            }

            let params = {
                prodId : param.prodId,
                userId : param.userId,
                custId: param.custId,
                reqGubun: '02',
                prodAmt : param.prodAmt,
                saleAmt : param.saleAmt,
                inflowCnt : param.inflowCnt,
                saleTotalAmt : param.refundSaleTotalAmt,
                dateWorkFrom : param.dateWorkFrom,
                dateWorkTo : param.refundDateWorkTo,
                workDay : param.refundWorkDay,
                incentiveRate : param.incentiveRate,
                refundInd : 'Y',
                refundSettlementSeq : param.settlementSeq,
                refundGubun : param.refundGubun,
                expectAmt : param.refundExpectAmt,
                expectRateAmt : param.refundExpectRateAmt
            }

            // 환불구분이 킵사용시
            if (param.refundGubun === '02') {
                params.saveMileage = param.refundExpectAmt;
            }

            if (confirm("데이터를 저장하시겠습니까?")) {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: apiUrl,
                        data: JSON.stringify(params),
                        contentType: 'application/json',
                        type: 'POST',
                        success: (result) => {
                            if (result > 0) {
                                alert("저장이 완료되었습니다.");
                                $('#refundModal').modal('hide');
                                searchPaymentGrid();
                            } else {
                                alert("저장에 실패하였습니다.");
                            }
                        }, error: (xhr, status, error) => {
                            alert(xhr.responseText);
                            return false;
                        }
                    })
                });
            }
        }

        const closeBeforeModal = () => {
            console.log('모달이 곧 닫힙니다!');
        }

        const closeAfterModal = () => {
            console.log('모달이 닫혔습니다!');
        }

        const modalAcceptBtn = () => {
            searchPaymentGrid();
        }

        const openPaymentModal = () => {
            $('#paymentModal').modal('show');

            $('#paymentModal').on('shown.bs.modal', () => {
                // 모달이 완전히 열린 후 실행
                paymentModalGrid.getGrid().clear();
                paymentModalGrid.getGrid().refreshLayout();

                searchPaymentModalGrid();
            });
        }

        const searchPaymentModalGrid = () => {
            const params = {};
            $('#' + paymentModalPrefix + 'searchTable input').each(function() {
                const id = $(this).attr('id');
                const name = $(this).attr('name');
                const value = $(this).val();

                if (id) {
                    params[name] = value;
                }
            });

            $.ajax({
                url: "/api/pages/refund/payment/list",
                data: params,
                type: 'GET',
                success: (result) => {
                    paymentModalGrid.bind(result);
                }, error: (xhr, status, error) => {
                    alert(xhr.responseText);
                    return false;
                }
            });
        }

        const applyPaymentModal = (param) => {
            // 환불요청 모달 clear
            $('#refundModal').clear();

            let focusedCell = paymentModalGrid.getGrid().getFocusedCell();
            const focusedRow = paymentModalGrid.getGrid().getRow(focusedCell.rowKey);

            if (!isNull(focusedCell)) {
                // 정산요청 모달 hide
                $('#paymentModal').modal('hide');

                // 환불요청 모달 > 정산요청 정보 바인딩
                $('.paymentDetail').bindForm(focusedRow);
            }
        }

    </script>

</div>

</html>