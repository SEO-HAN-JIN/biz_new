<!--<!DOCTYPE html>-->
<!--<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/framelayout}">-->


<th:block th:fragment="content">

    <div class="page-heading">
        <div class="page-title">
            <div class="row">
                <div class="col-12 col-md-6 order-md-1 order-last p-3">
                    <h3>환불관리</h3>
                </div>
                <div class="col-12 col-md-6 order-md-2 order-first">
                    <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">정산관리</li>
                            <li class="breadcrumb-item active" aria-current="page">환불요청</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>

        <section id="horizontal-input">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body pt-3 pb-3" id="searchForm">
                            <!--                            <div class="row align-items-center p-2" style="">-->
                            <div class="row align-items-center p-2 search-area custom-bg">
                                <div class="col-md-11">
                                    <div class="form-group row mb-0 align-items-center text-center">
                                        <label class="col-form-label col-lg-1 col-3">환불요청일</label>
                                        <div class="col-lg-3 col-9">
                                            <div class="d-flex">
                                                <input type="date" class="form-control form-control-sm me-2" id="searchStartDate" >
                                                <input type="date" class="form-control form-control-sm" id="searchEndDate" >
                                            </div>
                                        </div>
                                        <label class="col-form-label col-lg-1 col-3">고객명</label>
                                        <div class="col-lg-2 col-9">
                                            <input type="text" id="searchCustName" class="form-control form-control-sm" name="fname" placeholder="메뉴명">
                                        </div>
                                        <label class="col-form-label col-lg-1 col-3">상품명</label>
                                        <div class="col-lg-2 col-9">
                                            <input type="text" id="searchProdName" class="form-control form-control-sm" name="fname" placeholder="메뉴명">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-1 text-end">
                                    <a href="#" class="btn btn-primary cursor-auto" id="searchBtn">조회</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="row" id="basic-table">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex align-items-center gap-3">
                            <h4 class="card-title mb-0">환불신청내역</h4>
                            <span class="data-count">[총 <span id="data-count-value">0</span>건]</span>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-end" style="width: 100%;">
                                <div class="d-flex pb-3 gap-1">
                                    <button type="button" class="btn btn-primary btn-m" id="modalAddBtn" data-bs-toggle="modal" data-bs-target="#refundModal">추가</button>

                                    <button type="button" class="btn btn-secondary btn-m" id="btnDeleteRefundGrid">삭제</button>
                                </div>
                            </div>
                            <div id="refundGrid" class="tui-grid"></div>
                        </div>

                        <div class="modal fade" id="refundModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" data-bs-backdrop="static" data-bs-keyboard="false">
                            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
                                <div class="modal-content">
                                    <!-- Modal Header -->
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title text-white" id="exampleModalCenterTitle">환불요청 상세정보</h5>
                                        <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>

                                    <!-- Modal Body -->
                                    <div class="modal-body">
                                        <!-- 정산요청 정보섹션 -->
                                        <fieldset class="border p-3 rounded">
                                            <legend class="float-none w-auto px-2">정산요청 정보</legend>
                                            <div class="refundModal paymentDetail">
                                                <div class="row g-3">
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">정산번호</label>
                                                            <div class="d-flex align-items-center">
                                                                <input type="text" id="_refundModal_settlementSeq" class="form-control me-2" name="settlementSeq" disabled>
                                                                <button id="_refundModal_applyPaymentBtn" type="button" class="btn icon btn-outline-dark">
                                                                    <i class="bi bi-search"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">담당자</label>
                                                            <input type="text" id="_refundModal_empName" class="form-control" name="empName" disabled>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">고객</label>
                                                            <input type="text" id="_refundModal_custName" class="form-control" name="custName" disabled>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">상품</label>
                                                            <input type="text" id="_refundModal_prodName" class="form-control" name="prodName" disabled>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row g-3">
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">작업시작일</label>
                                                            <input type="date" id="_refundModal_dateWorkFrom" class="form-control" name="dateWorkFrom" disabled>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">작업종료일</label>
                                                            <input type="date" id="_refundModal_dateWorkTo" class="form-control" name="dateWorkTo" disabled>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">작업일수</label>
                                                            <input type="text" id="_refundModal_workDay" class="form-control is-num text-end" name="workDay" disabled>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">적용 인센티브율</label>
                                                            <input type="text" id="incentiveRate" name="incentiveRate" class="form-control is-num text-end" disabled>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row g-3">
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">유입수</label>
                                                            <input type="text" id="_refundModal_inflowCnt" class="form-control is-num text-end" name="inflowCnt" disabled>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">상품가(VAT)</label>
                                                            <input type="text" id="_refundModal_prodAmt" class="form-control is-num text-end" name="prodAmt" disabled>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">판매가(VAT)</label>
                                                            <input type="text" id="_refundModal_saleAmt" class="form-control is-num text-end" name="saleAmt" disabled>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">판매총액(VAT)</label>
                                                            <input type="text" id="_refundModal_saleTotalAmt" class="form-control is-num text-end" name="saleTotalAmt" disabled>
                                                        </div>
                                                    </div>
                                                    <input type="hidden" id="_refundModal_incentiveRate" name="incentiveRate">
                                                    <input type="hidden" id="_refundModal_custId" name="custId">
                                                    <input type="hidden" id="_refundModal_prodId" name="prodId">
                                                    <input type="hidden" id="_refundModal_userId" name="userId">
                                                    <input type="hidden" id="_refundModal_prodTotalAmt" name="prodTotalAmt">
                                                    <input type="hidden" id="_refundModal_expectAmt" name="expectAmt">
                                                    <input type="hidden" id="_refundModal_expectRateAmt" name="expectRateAmt">
                                                    <input type="hidden" id="_refundModal_mileageUseInd" name="mileageUseInd">
                                                    <input type="hidden" id="_refundModal_useMileage" name="useMileage">
                                                    <input type="hidden" id="_refundModal_reqGubun" name="reqGubun">
                                                    <input type="hidden" id="_refundModal_existMileage" name="existMileage">
                                                </div>
                                            </div>
                                        </fieldset>

                                        <!-- 정산 정보 섹션 -->
                                        <fieldset class="border p-3 rounded mt-4">
                                            <legend class="float-none w-auto px-2">환불요청 정보</legend>
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <div class="form-group">
                                                        <label class="form-label">환불요청일</label>
                                                        <input type="date" id="_refundModal_refundDate" class="form-control" name="refundDate">
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="form-group">
                                                        <label class="form-label">유입수</label>
                                                        <input type="text" id="_refundModal_refundInflowCnt" class="form-control is-num text-end" name="refundInflowCnt">
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="form-group">
                                                        <label class="form-label">환불일수</label>
                                                        <input type="text" id="_refundModal_refundWorkDay" class="form-control is-num text-end" name="refundWorkDay" disabled>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="form-group">
                                                        <label class="form-label">환불금액</label>
                                                        <input type="text" id="_refundModal_refundProdTotalAmt" class="form-control is-num text-end" name="refundProdTotalAmt" disabled>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <div class="form-group">
                                                        <label class="form-label">환불수수료</label>
                                                        <input type="text" id="_refundModal_refundExpectRateAmt" class="form-control is-num text-end" name="refundExpectRateAmt" disabled>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="form-group">
                                                        <label class="form-label">환불구분</label>
                                                        <select id="_refundModal_gubun" class="form-select form-control-sm" name="gubun">
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <input type="hidden" id="_refundModal_refundSaleTotalAmt" name="refundSaleTotalAmt">
                                        </fieldset>
                                    </div>

                                    <!-- Modal Footer -->
                                    <div class="modal-footer bg-light">
                                        <button type="button" class="btn btn-light-secondary" data-bs-dismiss="modal">
                                            <i class="bx bx-x"></i> 닫기
                                        </button>
                                        <button type="button" class="btn btn-primary ms-1" id="_refundModal_btnSave">
                                            <i class="bx bx-check"></i> 저장
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="modal fade" id="paymentModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" data-bs-backdrop="static" data-bs-keyboard="false">
                            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
                                <div class="modal-content">
                                    <!-- Modal Header -->
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title text-white" id="paymentModalTitle">정산요청내역</h5>
                                        <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>

                                    <section id="horizontal-input-modal">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div id="searchTable" class="table">
                                                    <div class="card-body pt-3 pb-3" id="modalSearchForm">
                                                        <div id="_paymentModal_searchTable">
                                                            <div class="row align-items-center p-2 search-area custom-bg">
                                                                <div class="col-md-10">
                                                                    <div class="form-group row mb-0 align-items-center text-center">
                                                                        <!-- 정산신청일 -->
                                                                        <div class="col-md-3 text-start">
                                                                            <label class="col-form-label">정산요청일</label>
                                                                        </div>
                                                                        <div class="col-md-5">
                                                                            <div class="d-flex justify-content-between">
                                                                                <input type="date" class="form-control form-control-sm me-2" id="_paymentModal_searchStartDate" name="searchStartDate">
                                                                                <input type="date" class="form-control form-control-sm" id="_paymentModal_searchEndDate" name="searchEndDate" >
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <!-- 조회 버튼 -->
                                                                <div class="col-md-2 text-end">
                                                                    <a href="#" class="btn btn-primary" id="_paymentModal_searchBtn">조회</a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </section>

                                    <!-- Modal Body -->
                                    <div class="modal-body">
                                        <h6>정산요청목록</h6>
                                        <div id="paymentModalGrid" style="height: 450px"></div>
                                    </div>

                                    <!-- Modal Footer -->
                                    <div class="modal-footer bg-light">
                                        <button type="button" class="btn btn-light-secondary" data-bs-dismiss="modal">
                                            <i class="bx bx-x"></i> 닫기
                                        </button>
                                        <button type="button" class="btn btn-primary ms-1" id="_paymentModal_applyBtn">
                                            <i class="bx bx-check"></i> 적용
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </section>
    </div>
    <style>
        .modal-backdrop {
            z-index: 1040; /* 배경 */
        }
        .modal.show {
            z-index: 1050; /* 첫 번째 모달 */
        }
        .modal.show + .modal {
            z-index: 1060; /* 두 번째 모달 */
        }
    </style>
    <script type="text/javascript">
        (function() {
        const apiUrl = '/api/pages/refund';

        let refundGrid;
        let paymentModalGrid;
        let $isNew = 'N';
        let paymentModalPrefix = '_paymentModal_';
        let refundModalPrefix = '_refundModal_';

        $(document).ready(function() {

            const nowYear = new Date().getFullYear();
            const nowMonth = new Date().getMonth();

            const startDate = new Date(nowYear, nowMonth, 1); // 당월 1일
            const endDate = new Date(nowYear, nowMonth + 1, 0); // 현재 달의 마지막 날

            // 포맷팅된 날짜 값을 input에 설정
            $("#searchStartDate").val(formatDate(startDate));
            $("#searchEndDate").val(formatDate(endDate));


            $("#_paymentModal_searchStartDate").val(formatDate(startDate));
            $("#_paymentModal_searchEndDate").val(formatDate(endDate));

            $("#btnDeleteRefundGrid").on('click', fn_deleteRefundGrid);

            findInitCodes();
            initEvent();
            initRefundGrid();
            initPaymentModalGrid();

            $('.is-num').bind('keyup', numberKeyupEvent);
        });

        const findInitCodes = async () => {
            const param =
                [
                    {"patternCode": "SE02", "groupCode": "B"}
                ];

            const result = await CommonJs.initFindCodes(param);
            findCodeCallback(result);
        }

        const findCodeCallback = (result) => {
            const options = {
                value: 'baseCode',
                text: 'codeName',
                items: result.SE02,
                placeholder: '선택'
            };
            $("#" + refundModalPrefix + "gubun").addOptions(options);
        }

        const initEvent = () => {

            $(document).on("keydown", function (e) {
                if (e.key === "Escape") {
                    const $activeModals = $(".modal.show");
                    let activeModals = $activeModals.map(function () {
                        return $(this).attr("id");
                    }).get();

                    if (activeModals.length >= 2) {
                        $("#paymentModal").modal('hide');
                    } else {
                        $("#refundModal").modal('hide');
                    }
                    e.preventDefault(); // Bootstrap 기본 동작 방지
                    e.stopPropagation(); // 이벤트 전파 차단
                }
            });

            $("#modalAddBtn").on('click', function() {
                openPgmModal('1')
            });

            $("#searchBtn").on('click', searchRefundGrid);

            $("#" + refundModalPrefix + "applyPaymentBtn").on('click', openPaymentModal);

            $("#" + paymentModalPrefix + "applyBtn").on('click', applyPaymentModal);
            $("#" + paymentModalPrefix + "searchBtn").on('click', searchPaymentModalGrid);

            $("#" + refundModalPrefix + "refundDate").on('change', validRefundDate);
            $("#" + refundModalPrefix + "refundInflowCnt").on('change', saleSum);
            $("#" + refundModalPrefix + "btnSave").on('click', saveRefund);
        }


        function selectKeepInd(obj) {

            var keepInd = obj.checked;

            var inputElement = $("#custKeepUseAmt");

            if (keepInd) {
                // Enable the element
                $(inputElement).prop("disabled", false);
            } else {
                // Disable the element
                $(inputElement).prop("disabled", true);
            }
        }

        const validRefundDate = () => {
            const d1 = $("#" + refundModalPrefix + "dateWorkTo").val();
            const d2 = $("#" + refundModalPrefix + "refundDate").val();
            const d3 = $("#" + refundModalPrefix + "dateWorkFrom").val();

            const date1 = new Date(d1); // 정산-작업종료일
            const date2 = new Date(d2); // 환불-요청일
            const date3 = new Date(d3); // 정산-작업시작일

            if (date1.getTime() < date2.getTime()) {
                alert("환불요청일은 정산요청의 작업종료일 이전이어야 합니다.");
                $("#" + refundModalPrefix + "refundDate").val('');
                $("#" + refundModalPrefix + "refundWorkDay").val('');
                $("#" + refundModalPrefix + "refundSaleTotalAmt").val('');
                $("#" + refundModalPrefix + "refundExpectRateAmt").val('');
                return;
            }

            setRefundWorkDay();
        }

        const setRefundWorkDay = () => {

            const d1 = $("#" + refundModalPrefix + "dateWorkTo").val();
            const d2 = $("#" + refundModalPrefix + "refundDate").val();

            const date1 = new Date(d1);
            const date2 = new Date(d2);

            const diffDate = date1.getTime() - date2.getTime();
            const refundDays = Math.abs(diffDate / (1000 * 60 * 60 * 24));

            let reqDays = $("#_refundModal_workDay").val();
            if (refundDays > reqDays) {
                alert("환불요청 일 수는 정산요청일 수 보다 많을 수 없습니다.");
                $("#" + refundModalPrefix + "refundDate").val('');
                $("#" + refundModalPrefix + "refundWorkDay").val('');
                $("#" + refundModalPrefix + "refundSaleTotalAmt").val('');
                $("#" + refundModalPrefix + "refundExpectRateAmt").val('');
                return;
            }

            $("#" + refundModalPrefix + "refundWorkDay").val(refundDays);

            saleSum();
        }

        function saleSum() {

            const prodAmt = isNull($("#" + refundModalPrefix + "prodAmt").val()) ? 0 : parseFloat(removeComma($("#" + refundModalPrefix + "prodAmt").val()));          // 상품가(공급가)
            const saleAmt = isNull($("#" + refundModalPrefix + "saleAmt").val()) ? 0 : parseFloat(removeComma($("#" + refundModalPrefix + "saleAmt").val()));          // 판매가
            const refundInflowCnt = isNull($("#" + refundModalPrefix + "refundInflowCnt").val()) ? 0 : parseInt(removeComma($("#" + refundModalPrefix + "refundInflowCnt").val()));    // 유입수
            const workDay = isNull($("#" + refundModalPrefix + "refundWorkDay").val()) ? 0 : parseInt($("#" + refundModalPrefix + "refundWorkDay").val());           // 환불일수
            const incentiveRate = isNull($("#" + refundModalPrefix + "incentiveRate").val()) ? 0 : parseFloat($("#" + refundModalPrefix + "incentiveRate").val());   // 직원인센티브율

            // 부가세율 설정 (10% 부가세)
            const vatRate = 1.1;

            // 환불상품총액(상품가 * 유입수 * 환불일수) * 부가세
            //const saleTotalAmt = Math.floor((prodAmt *  refundInflowCnt * workDay) * vatRate);
            // * 환불상품총액 부가세 제외
            const saleTotalAmt = Math.floor((prodAmt *  refundInflowCnt * workDay));

            // 환불판매총액 (판매가 * 유입수 * 환불일수) * 부가세
            //const prodTotalAmt = Math.floor((saleAmt * refundInflowCnt * workDay) * vatRate);
            // * 환불판매총액 부가세 제외
            const prodTotalAmt = Math.floor((saleAmt * refundInflowCnt * workDay));

            // 영업이익 (환불판매총액 - 환불상품총액)
            var costAmt = saleTotalAmt - prodTotalAmt;

            // 환불수수료 (영업이익 * 인센티브 / 1.1)
            var expectRateAmt = 0;

            if(["07"].includes($("#_refundModal_gubun").val()))
                expectRateAmt = saleTotalAmt;
            else
                expectRateAmt = Math.floor((costAmt * incentiveRate) / vatRate);

            $("#" + refundModalPrefix + "refundSaleTotalAmt").val(formatNumber(saleTotalAmt));      // 환불판매총액
            $("#" + refundModalPrefix + "refundProdTotalAmt").val(formatNumber(prodTotalAmt));      // 환불상품총액
            $("#" + refundModalPrefix + "refundExpectRateAmt").val(formatNumber(expectRateAmt));    // 환불수수료
        }


        const initRefundGrid = () => {

            var columns = new CustomTuiGrid()
                .setFitStyle('fill')  // 페이지 폭에 맞추어 그리드를 채우기
                .add('refundSettlementSeq', '환불번호', 250, {})
                .add('empName', '담당자', 150, {})
                .add('custName', '고객명', 150, {})
                .add('prodName', '상품명', 200, { align: 'center' })
                .addDate('refundDate', '환불요청일', 150, {})
                .add('refundWorkDay', '환불일수', 120, {align: 'right'})
                .add('refundInflowCnt', '유입수', 120, {align: 'right'})
                .addNumber('refundSaleTotalAmt', '판매총액', 200, {
                    align: 'right',
                    textColor: 'red',
                    comma: true,
                    summary: {
                        template: valueMap => `합계: ${valueMap.sum.toLocaleString()}`
                    }})
                .addNumber('refundSaleTotalAmt', '환불금액', 200, {
                    align: 'right',
                    textColor: 'red',
                    comma: true,
                    summary: {
                        template: valueMap => `${valueMap.sum.toLocaleString()}`
                    }})
                .addNumber('refundExpectRateAmt', '환불수수료', 200, {
                    align: 'right',
                    textColor: 'red',
                    comma: true,
                    summary: {
                        template: valueMap => `${valueMap.sum.toLocaleString()}`
                    }})
                .add('settlementSeq', '정산번호', 250, {})
                .add('gubunName', '환불구분', 150, {})
                .add('applyStatusName', '진행상태', 150, {})
                .add('workDay', '작업일수', 'auto', {visible: false})
                .add('saleTotalAmt', '판매총액', 'auto', {visible: false})
                .add('gubun', '환불구분', 'auto', {visible: false})
                .addNumber('prodAmt', '상품가', 150, { visible: false})
                .addNumber('saleAmt', '판매가', 120, { visible: false})
                .add('inflowCnt', '유입수', 120, {visible: false})
                .addDate('dateWorkFrom', '작업시작일', 150, {visible: false})
                .addDate('dateWorkTo', '작업종료일', 150, {visible: false})
                .add('prodTotalAmt', '상품가액', 120, {visible: false})
                .add('expectAmt', '예상정산금액', 120, {visible: false})
                .add('expectRateAmt', '예정수수료', 120, {visible: false})
                .add('mileageUseInd', '마일리지사용여부', 120, {visible: false})
                .add('useMileage', '마일리지사용금액', 120, {visible: false})
                .add('existMileage', '기존마일리지', 120, {visible: false})
            ;

            refundGrid = columns.init('refundGrid', [])
                .render();

            // 더블 클릭 이벤트 설정
            refundGrid.getGrid().on('dblclick', function(ev) {
                openPgmModal('2');
            });

            searchRefundGrid();
        }

        const initPaymentModalGrid = () => {
            var columns = new CustomTuiGrid()
                // .setFitStyle('fill')  // 페이지 폭에 맞추어 그리드를 채우기
                .add('settlementSeq', '정산번호', 150, {})
                .add('empName', '담당자', 100, {})
                .add('custName', '고객명', 100, {})
                .add('prodName', '상품명', 100, { align: 'center' })
                .addDate('dateWorkFrom', '작업시작일', 100, {})
                .addDate('dateWorkTo', '작업종료일', 100, {})
                .addDate('workDay', '작업일수', 100, {})
                .add('statusName', '진행상태', 'auto', {visible: false})
                .add('prodAmt', '상품가', 'auto', {visible: false})
                .add('saleAmt', '판매가', 'auto', {visible: false})
                .add('inflowCnt', '유입수', 'auto', {visible: false})
                .addNumber('saleTotalAmt', '판매총액', 'auto', {visible: false})
                .addNumber('depositRealAmt', '실제입금액', 'auto', {visible: false})
                .add('incentiveRate', '직원인센티브율', 'auto', {visible: false})
            ;

            paymentModalGrid = columns.init('paymentModalGrid', [])
                .render();

            // 더블 클릭 이벤트 설정
            paymentModalGrid.getGrid().on('dblclick', function(ev) {
                applyPaymentModal();
            });
        }

        const searchRefundGrid = () => {

            let startDate = $("#searchStartDate").val();
            let endDate = $("#searchEndDate").val();

            if (isNull(startDate) || isNull(endDate)) {
                alert("환불요청일을 입력해주세요");
                return;
            }

            refundGrid.clear();

            const param = {
                searchStartDate : $("#searchStartDate").val(),
                searchEndDate: $("#searchEndDate").val(),
                custName: $("#searchCustName").val(),
                prodName: $("#searchProdName").val()
            };

            $.ajax({
                url: apiUrl,
                data: param,
                type: 'GET',
                success: (result) => {

                    if(result.length > 0) {
                        refundGrid.bind(result);
                    }
                }
            });
        }

        const openPgmModal = (param) => {

            if (param === '1') {
                $isNew = true;
                $("#_refundModal_applyPaymentBtn").attr('disabled', false);
            } else {
                $isNew = false;
                $("#_refundModal_applyPaymentBtn").attr('disabled', true);
            }

            clearForm('refundModal');

            // 행 더블 클릭 시
            if (param === '2') {
                const focusedCell = refundGrid.getGrid().getFocusedCell();
                const data = refundGrid.getGrid().getRow(focusedCell.rowKey);

                $('#refundModal').bindForm(data);

                $("#_refundModal_refundDate").attr('disabled', true);
                $("#_refundModal_gubun").attr('disabled', true);
                $("#_refundModal_btnSave").attr('disabled', true);
                $("#_refundModal_applyPaymentBtn").attr('disabled', true);
                $("#_refundModal_refundInflowCnt").attr('disabled', true);
            } else {
                $("#_refundModal_refundDate").attr('disabled', false);
                $("#_refundModal_gubun").attr('disabled', false);

                $("#_refundModal_btnSave").attr('disabled', false);
                $("#_refundModal_applyPaymentBtn").attr('disabled', false);
                $("#_refundModal_refundInflowCnt").attr('disabled', false);
            }


            $('#refundModal').modal('show');

        }

        const clearForm = (id) => {
            $('#' + id).find('input, select, textarea').each(function () {
                if ($(this).is(':checkbox')) {
                    // 체크박스는 체크 해제
                    $(this).prop('checked', false);
                } else if ($(this).is('select')) {
                    const obj = this;
                    if (obj.classList.contains('choices') && obj.choicesInstance) {
                        // Choices.js가 적용된 select 초기화
                        obj.choicesInstance.setChoiceByValue(''); // 선택값 초기화
                    } else {
                        // 일반 select는 첫 번째 값으로 초기화
                        $(this).val($(this).find('option:first').val());
                    }
                } else {
                    // 나머지 input 및 textarea는 빈 값으로 초기화
                    $(this).val('');
                }
            });
        };


        const saveRefund = () => {
            const param = {};
            $('#refundModal').find('input, select, input[type="checkbox"]').each((index, item) => {
                // checkbox일 때
                if ($(item).is(':checkbox')) {
                    param[item.name] = $(item).prop('checked') ? 'Y' : 'N'; // 체크 여부에 따라 Y 또는 N 설정
                } else {
                    // input일 때의 처리
                    param[item.name] = item.value.replace(/,/g, ''); // input 값 설정
                }
            });

            if(isNull(param.refundDate))
            {
                alert("환불요청일을 입력해주세요.");
                return false;
            }

            if(isNull(param.gubun))
            {
                alert("환불구분을 입력해주세요.");
                return false;
            }

            if (confirm("데이터를 저장하시겠습니까?")) {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: apiUrl,
                        data: JSON.stringify(param),
                        contentType: 'application/json',
                        type: 'POST',
                        success: (result) => {
                            if (result > 0) {
                                alert("저장이 완료되었습니다.");
                                $('#refundModal').modal('hide');
                                searchRefundGrid();
                            } else {
                                alert("저장에 실패하였습니다.");
                            }
                        }, error: (xhr, status, error) => {
                            alert(xhr.responseText);
                            return false;
                        }
                    })
                });
            }
        }

        const closeBeforeModal = () => {
            console.log('모달이 곧 닫힙니다!');
        }

        const closeAfterModal = () => {
            console.log('모달이 닫혔습니다!');
        }

        const modalAcceptBtn = () => {
            searchRefundGrid();
        }

        const openPaymentModal = () => {
            $('#paymentModal').modal('show');

            $('#paymentModal').on('shown.bs.modal', () => {
                // 모달이 완전히 열린 후 실행
                paymentModalGrid.getGrid().clear();
                paymentModalGrid.getGrid().refreshLayout();

                searchPaymentModalGrid();
            });
        }

        const searchPaymentModalGrid = () => {
            const params = {};
            $('#' + paymentModalPrefix + 'searchTable input').each(function() {
                const id = $(this).attr('id');
                const name = $(this).attr('name');
                const value = $(this).val();

                if (id) {
                    params[name] = value;
                }
            });

            $.ajax({
                url: "/api/pages/refund/payment/list",
                data: params,
                type: 'GET',
                success: (result) => {
                    paymentModalGrid.bind(result);
                }, error: (xhr, status, error) => {
                    alert(xhr.responseText);
                    return false;
                }
            });
        }

        const applyPaymentModal = (param) => {
            // 환불요청 모달 clear
            $('#refundModal').clear();

            let focusedCell = paymentModalGrid.getGrid().getFocusedCell();
            const focusedRow = paymentModalGrid.getGrid().getRow(focusedCell.rowKey);

            if (!isNull(focusedCell)) {
                // 정산요청 모달 hide
                $('#paymentModal').modal('hide');

                $("#_refundModal_gubun").attr('disabled', false);
                $("#_refundModal_gubun").val('');

                if(["05", "06"].includes(focusedRow.gubun)) {
                    $("#_refundModal_gubun").attr('disabled', true);
                    $("#_refundModal_gubun").val('07');
                }

                // 환불요청 모달 > 정산요청 정보 바인딩
                $('.paymentDetail').bindForm(focusedRow);
                $("input[name=refundInflowCnt]").val(formatNumber(focusedRow.inflowCnt));
            }
        }

        const fn_deleteRefundGrid = () => {
            const focusedCell = refundGrid.getGrid().getFocusedCell();
            if (isNull(focusedCell)) {
                alert("삭제할 행을 선택해주세요.");
                return;
            }

            const data = refundGrid.getGrid().getRow(focusedCell.rowKey);
            if (data.applyStatus !== '01') {
                alert("환불요청건만 삭제가 가능합니다.");
                return;
            }

            const confirmResult = confirm("선택한 행의 데이터를 삭제하시겠습니까?");
            if (confirmResult) {
                const focusRow = refundGrid.getGrid().getRow(focusedCell.rowKey);
                let params = {
                    settlementSeq: focusRow.refundSettlementSeq,
                    prodId: focusRow.prodId,
                    userId: focusRow.userId,
                    custId: focusRow.custId
                }
                $.ajax({
                    url: apiUrl,
                    data: JSON.stringify(params),
                    contentType: 'application/json',
                    type: 'DELETE',
                    success: (result) => {
                        if (result > 0) {
                            alert("삭제가 완료되었습니다.");
                            searchRefundGrid();
                        } else {
                            alert("삭제에 실패하였습니다.");
                            searchRefundGrid();
                        }
                    }, error: (xhr, status, error) => {
                        alert(xhr.responseText);

                    }
                })
            }
        }
        })();
    </script>

</th:block>

<!--</html>-->