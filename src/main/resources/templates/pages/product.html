<!--<!DOCTYPE html>-->
<!--<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/framelayout}">-->


<th:block th:fragment="content">

    <div class="page-heading">
        <div class="page-title">
            <div class="row">
                <div class="col-12 col-md-6 order-md-1 order-last p-3">
                    <h3>ÏÉÅÌíàÍ¥ÄÎ¶¨</h3>
                </div>
                <div class="col-12 col-md-6 order-md-2 order-first">
                    <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">ÏóÖÎ¨¥Í¥ÄÎ¶¨</li>
                            <li class="breadcrumb-item active" aria-current="page">ÏÉÅÌíàÍ¥ÄÎ¶¨</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>

        <section id="horizontal-input">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body pt-3 pb-3" id="searchForm">
<!--                            <div class="row align-items-center p-2" style="">-->
                            <div class="row align-items-center p-2 search-area custom-bg">
                                <div class="col-md-11">
                                    <div class="form-group row mb-0 align-items-center text-center">
                                        <label class="col-form-label col-lg-1 col-3">ÏÉÅÌíàÏΩîÎìú</label>
                                        <div class="col-lg-2 col-9">
                                            <input type="text" id="_search_prodId" class="form-control form-control-sm" name="prodId" placeholder="ÏÉÅÌíàÏΩîÎìú">
                                        </div>
                                        <label class="col-form-label col-lg-1 col-3">ÏÉÅÌíàÎ™Ö</label>
                                        <div class="col-lg-2 col-9">
                                            <input type="text" id="_search_prodName" class="form-control form-control-sm" name="prodName" placeholder="ÏÉÅÌíàÎ™Ö">
                                        </div>
                                        <label class="col-form-label col-lg-1 col-3">ÏÇ¨Ïö©Ïó¨Î∂Ä</label>
                                        <div class="col-lg-3 col-9">
                                            <div class="d-flex">
                                                <select class="form-select" id="_search_useInd" name="useInd"></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-1 text-end">
                                    <a href="#" class="btn btn-primary" id="searchBtn">Ï°∞Ìöå</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="row" id="basic-table">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">ÏÉÅÌíàÍ¥ÄÎ¶¨ÎÇ¥Ïó≠</h4>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-end" style="width: 100%;">
                                <div class="d-flex pb-3 gap-1">
                                    <button type="button" class="btn btn-primary btn-sm" id="modalAddBtn" data-bs-toggle="modal" data-bs-target="#productModal">Ï∂îÍ∞Ä</button>

                                    <button type="button" class="btn btn-secondary btn-sm" id="btnDeleteProductGrid">ÏÇ≠Ï†ú</button>
                                </div>
                            </div>
                            <div id="productGrid" class="tui-grid"></div>
                        </div>

                        <!-- ÏÉÅÌíà Ï†ïÎ≥¥ Î™®Îã¨ -->
                        <div class="modal fade" id="productModal" tabindex="-1" role="dialog" aria-labelledby="productModalTitle" aria-hidden="true" data-bs-backdrop="static">
                            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
                                <div class="modal-content shadow-sm rounded-3 border-0">
                                    <div class="modal-header bg-primary text-white rounded-top">
                                        <h5 class="modal-title text-white" id="productModalCenterTitle text-white">ÏÉÅÌíà Ï†ïÎ≥¥</h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>

                                    <div class="card-body p-4">
                                        <form id="productForm" class="form">
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-4">
                                                    <label class="form-label" for="_productPop_prodId">ÏÉÅÌíàÏΩîÎìú</label>
                                                    <input type="text" id="_productPop_prodId" class="form-control" name="prodId" placeholder="ÏÉÅÌíàÏΩîÎìú ÏûêÎèô ÏÉùÏÑ±">
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label" for="_productPop_prodName">ÏÉÅÌíàÎ™Ö</label>
                                                    <input type="text" id="_productPop_prodName" class="form-control" name="prodName">
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label" for="_productPop_prodAmt">ÏÉÅÌíàÍ∞Ä</label>
                                                    <input type="text" id="_productPop_prodAmt" class="form-control is-num text-end" name="prodAmt">
                                                </div>
                                            </div>
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-4">
                                                    <label class="form-label" for="_productPop_prodIncentive">ÏÉÅÌíàÏàòÏàòÎ£å</label>
                                                    <input type="text" id="_productPop_prodIncentive" class="form-control is-num text-end" name="prodIncentive">
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label" for="_productPop_useInd">ÏÇ¨Ïö©Ïó¨Î∂Ä</label>
                                                    <select class="form-select" id="_productPop_useInd" name="useInd"></select>
                                                </div>
                                            </div>
                                        </form>

                                        <div class="d-flex justify-content-between align-items-center mt-4 mb-2">
                                            <h6 class="mb-0">ÏÉÅÌíà Ìï≠Î™© Î™©Î°ù</h6>
                                            <div>
                                                <button type="button" class="btn btn-outline-primary btn-sm" id="productModalGridAddBtn">
                                                    Ï∂îÍ∞Ä
                                                </button>
                                                <button type="button" class="btn btn-primary btn-sm" id="productModalGridDeleteBtn">
                                                    ÏÇ≠Ï†ú
                                                </button>
                                            </div>
                                        </div>

                                        <div id="productModalGrid" class="tui-grid" style="height: 250px;"></div>
                                    </div>


                                    <!-- Modal Footer -->
                                    <div class="modal-footer bg-light rounded-bottom d-flex justify-content-end">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                            Îã´Í∏∞
                                        </button>
                                        <button type="button" class="btn btn-success ms-2" id="modalSaveBtn">
                                            üíæ Ï†ÄÏû•
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <script type="text/javascript">
        (function() {
        const apiUrl = '/api/pages/product';
        const _popPrefix_ = '_productPop_';

        let productGrid;
        let productModalGrid;

        let $isNew;
        let $needSearch = false;

        $(document).ready(function() {
            initEvent();
            findInitCodes();
        });

        const initEvent = () => {
            $("#modalAddBtn").on('click', function() {
                openProductPop('1');
            });
            $("#modalSaveBtn").on('click', fn_saveProductGrid);

            $("#searchBtn").on('click', searchProductGrid);
            $("#btnDeleteProductGrid").on('click', fn_deleteProductGrid);

            $('#productModalGridAddBtn').on('click', addRowModalGrid);
            $('#productModalGridDeleteBtn').on('click', deleteRowModalGrid);

            $("#searchForm").on('keydown', function(event) {
                if (event.key === "Enter") {
                    event.preventDefault(); // ÌèºÏùò Í∏∞Î≥∏ Ï†úÏ∂ú Î∞©ÏßÄ
                    $("#searchBtn").click(); // Í≤ÄÏÉâ Î≤ÑÌäº ÌÅ¥Î¶≠ Ìä∏Î¶¨Í±∞
                }
            });

            // Ïà´Ïûê input ÏΩ§Îßà ÌòïÏãù
            $(".priceformat").on('input', function(){
                var obj = $(this);
                obj.val(formatNumber(obj.val()));
            });

            $('.is-num').bind('keyup', numberKeyupEvent);

            $('#productModal').on('shown.bs.modal', () => {
                productModalGrid.getGrid().clear();
                productModalGrid.getGrid().refreshLayout();

                if ($needSearch) {
                    searchProductModalGrid();
                }
            });
        }

        const findInitCodes = async () => {
            const param =
                [
                    {"patternCode": "SE06"}      // ÏÇ¨Ïö©Ïó¨Î∂Ä
                ];

            const result = await CommonJs.initFindCodes(param);
            findCodeCallback(result);
        }

        const findCodeCallback = (result) => {
            let SE06Options;
            SE06Options=  {
                value: 'baseCode',
                text: 'codeName',
                items: result.SE06,
                placeholder: 'Ï†ÑÏ≤¥'
            };
            $("#_search_useInd").addOptions(SE06Options);

            SE06Options = {
                value: 'baseCode',
                text: 'codeName',
                items: result.SE06,
                placeholder: 'ÏÑ†ÌÉù'
            };
            $("#_productPop_useInd").addOptions(SE06Options);

            initProductGrid();
            initProductModalGrid();
        }

        const initProductGrid = () => {


            var columns = new CustomTuiGrid()
                .add('prodId', 'ÏÉÅÌíàÏΩîÎìú', 100, {})
                .add('prodName', 'ÏÉÅÌíàÎ™Ö', 150, {})
                .addNumber('prodAmt', 'ÏÉÅÌíàÍ∞Ä', 150, {
                    align: 'right',
                    comma: true,
                })
                .add('useIndName', 'ÏÇ¨Ïö©Ïó¨Î∂Ä', 70, { align: 'center' })
                .addNumber('prodIncentive', 'ÏÉÅÌíàÏàòÏàòÎ£å', 80, {
                    align: 'right',
                    comma: true,
                })
                .add('useInd', 'ÏÇ¨Ïö©Ïó¨Î∂Ä', 70, { visible: false })
                .setFitStyle('fill')  // ÌéòÏù¥ÏßÄ Ìè≠Ïóê ÎßûÏ∂îÏñ¥ Í∑∏Î¶¨ÎìúÎ•º Ï±ÑÏö∞Í∏∞

            productGrid = columns.init('productGrid', [])
                .render();

            // ÎçîÎ∏î ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
            productGrid.getGrid().on('dblclick', function(ev) {
                openProductPop('2');
            });

            searchProductGrid();
        }


        const initProductModalGrid = () => {
            var columns = new CustomTuiGrid()
                .addNumber('seq', 'ÏàúÎ≤à', 250, {
                    editor: true,
                    align: 'center',
                    comma: true,
                })
                .add('name', 'Ìï≠Î™©Î™Ö', 480, {editor: true})
                .add('prodId', 'ÏÉÅÌíàÏΩîÎìú', 100, {visible: false})
                // .setFitStyle('fill')  // ÌéòÏù¥ÏßÄ Ìè≠Ïóê ÎßûÏ∂îÏñ¥ Í∑∏Î¶¨ÎìúÎ•º Ï±ÑÏö∞Í∏∞

            productModalGrid = columns.init('productModalGrid', [])
                .render();
        }

        const searchProductGrid = () => {
            productGrid.clear();

            const param = {
                prodId : $("#_search_prodId").val(),
                prodName : $("#_search_prodName").val(),
                useInd: $("#_search_useInd").val()
            };

            $.ajax({
                url: apiUrl,
                data: param,
                type: 'GET',
                success: (result) => {
                    if(result.length > 0) {
                        productGrid.bind(result);
                    }
                }
            });
        }

        // param : 1(Ï∂îÍ∞ÄÎ≤ÑÌäº) , 2(Í∑∏Î¶¨Îìú ÎçîÎ∏îÌÅ¥Î¶≠)
        const openProductPop = (param) => {

            clearForm('productModal');
            $("#" + _popPrefix_ + "prodId").attr('disabled', false);

            // ÏÖÄ ÎçîÎ∏î Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú
            if (param === '2') {
                $isNew = false;
                $needSearch = true;

                $("#" + _popPrefix_ + "prodId").attr('disabled', true);

                const focusedCell = productGrid.getGrid().getFocusedCell();
                const focusedData = productGrid.getGrid().getRow(focusedCell.rowKey);

                $('#productModal').bindForm(focusedData);

            } else {
                $isNew = true;
                $needSearch = false;

                $("#" + _popPrefix_ + "prodId").attr('disabled', false);
            }

            $('#productModal').modal('show');
        }

        const clearForm = (id) => {
            $('#' + id).find('input, select, textarea').each(function () {
                if ($(this).is(':checkbox')) {
                    // Ï≤¥ÌÅ¨Î∞ïÏä§Îäî falseÎ°ú ÏÑ§Ï†ï
                    $(this).prop('checked', false);
                } else {
                    // Í∑∏ Ïô∏Ïùò ÏûÖÎ†• ÌïÑÎìúÎäî Îπà Î¨∏ÏûêÏó¥Î°ú ÏÑ§Ï†ï
                    $(this).val('');
                }
            });
        };


        const fn_saveProductGrid = () => {
            // Îã§Î•∏ ÏûÑÏùò ÏÖÄÎ°ú Ìè¨Ïª§Ïä§ Î≥ÄÍ≤Ω ‚Üí Í∞ÑÏ†ëÏ†ÅÏúºÎ°ú ÌòÑÏû¨ ÏÖÄ Ìè¨Ïª§Ïä§ Ìï¥Ï†ú
            productModalGrid.getGrid().focus(0, 'seq');

            const param = {};
            $('#productModal').find('input, select, input[type="checkbox"]').each((index, item) => {
                // checkboxÏùº Îïå
                if ($(item).is(':checkbox')) {
                    param[item.name] = $(item).prop('checked') ? 'Y' : 'N'; // Ï≤¥ÌÅ¨ Ïó¨Î∂ÄÏóê Îî∞Îùº Y ÎòêÎäî N ÏÑ§Ï†ï
                } else {
                    // inputÏùº ÎïåÏùò Ï≤òÎ¶¨
                    param[item.name] = item.value.replace(/,/g, ''); // input Í∞í ÏÑ§Ï†ï
                }
            });

            if (isNull(param.prodName)) {
                alert("ÏÉÅÌíàÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                return false;
            }

            if (isNull(param.prodAmt)) {
                alert("ÏÉÅÌíàÍ∞ÄÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                return false;
            }

            if (isNull(param.useInd)) {
                alert("ÏÇ¨Ïö©Ïó¨Î∂ÄÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                return false;
            }

            if ($isNew) {
                param.rowStatus = "C";
            } else {
                param.rowStatus = "U";
            }

            param.productModalGridDtoList = productModalGrid.getGrid().getData();

            if (confirm("Îç∞Ïù¥ÌÑ∞Î•º Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: apiUrl,
                        data: JSON.stringify(param),
                        contentType: 'application/json',
                        type: 'POST',
                        success: (result) => {
                            if (result > 0) {
                                alert("Ï†ÄÏû•Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.");
                                $('#productModal').modal('hide');
                                searchProductGrid();
                            } else {
                                alert("Ï†ÄÏû•Ïóê Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§.");
                                $('#productModal').modal('hide');
                                searchProductGrid();
                            }
                        }, error: (xhr, status, error) => {
                            alert(xhr.responseText);
                            return false;
                        }
                    })
                });
            }
        }

        const fn_deleteProductGrid = () => {
            const focusedCell = productGrid.getGrid().getFocusedCell();
            if (isNull(focusedCell)) {
                alert("ÏÇ≠Ï†úÌï† ÌñâÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                return;
            }

            const confirmResult = confirm("ÏÑ†ÌÉùÌïú ÌñâÏùò Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?");
            if (confirmResult) {
                const focusRow = productGrid.getGrid().getRow(focusedCell.rowKey);
                let params = {
                    prodId : focusRow.prodId,
                }
                $.ajax({
                    url: apiUrl,
                    data: JSON.stringify(params),
                    contentType:'application/json',
                    type: 'DELETE',
                    success: (result) => {
                        if (result > 0) {
                            alert("ÏÇ≠Ï†úÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.");
                            searchProductGrid();
                        } else {
                            alert("ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§.");
                            searchProductGrid();
                        }
                    }
                })
            }
        }

        const closeBeforeModal = () => {
            console.log('Î™®Îã¨Ïù¥ Í≥ß Îã´ÌûôÎãàÎã§!');
        }

        const closeAfterModal = () => {
            console.log('Î™®Îã¨Ïù¥ Îã´ÌòîÏäµÎãàÎã§!');
        }


        const modalAcceptBtn = () => {
            searchProductGrid();
        }


        function openPop(url, options) {
            if(self != top) {
                window.parent.openPop(url, options);
                return;
            }
            var container = document.getElementById("popup-container");
            if(container instanceof HTMLDivElement === false) {
                container = document.createElement("div");
                container.id = "popup-container";
                container.className = "popup-container";
                container.style.opacity = "0";
                container.style.display = "none";
                document.body.appendChild(container);
            }
            container.innerHTML = "";

            var popId = _.camelCase(_.nth(_.split(url, "/"), -2));
            if(!_.isEmpty(window[popId])) {
                window[popId].open(options);
            }
            else {
                fetch(url)
                    .then(function(response) {
                        return response.text();
                    })
                    .then(function(text) {
                        container.innerHTML = text;
                        Ustra.docReady(function() {
                            Array.from(container.querySelectorAll("script")).forEach(function(item) {
                                eval.apply(this, [item.textContent]);
                            });
                            if(!_.isEmpty(window[popId])) {
                                window[popId].open(options);
                            }
                        }, container);
                    });
            }
        }

        function formatCurrency() {
            console.log("# abc #");
            // ÌòÑÏû¨ ÏûÖÎ†• Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
            let value = $(this).val();

            // Ïà´Ïûê Ïù¥Ïô∏Ïùò Î¨∏Ïûê Ï†úÍ±∞
            value = value.replace(/[^0-9]/g, '');

            // Ï≤ú Îã®ÏúÑÎ°ú ÏΩ§Îßà Ï∂îÍ∞Ä
            if (value) {
                value = Number(value).toLocaleString();  // ÏΩ§Îßà Ï∂îÍ∞Ä
            }

            // Ìè¨Îß∑ÌåÖÎêú Í∞íÏùÑ ÏûÖÎ†• ÌïÑÎìúÏóê ÏÑ§Ï†ï
            $(this).val(value);
        }

        const addRowModalGrid = () => {
            const focusedCell = productGrid.getGrid().getFocusedCell();
            const focusedData = productGrid.getGrid().getRow(focusedCell.rowKey);

            const allRow = productModalGrid.getGrid().getData();

            let list = [];
            let row = {};

            row.prodId = focusedData.prodId;
            if (allRow.length === 0) {
                row.seq = '1';
            } else {
                row.seq = (allRow.reduce((max, row) => {
                    const seq = Number(row.seq ?? 0);
                    return seq > max ? seq : max;
                }, 0) + 1).toString();
            }
            list.push(row);
            productModalGrid.getGrid().appendRows(list, {});
        }

        const deleteRowModalGrid = () => {
            const confirmResult = confirm("ÏÑ†ÌÉùÌïú ÌñâÏùò Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?");
            if (confirmResult) {

                const focusedCell = productModalGrid.getGrid().getFocusedCell();
                const focusedData = productModalGrid.getGrid().getRow(focusedCell.rowKey);

                $.ajax({
                    url: apiUrl + "/delete/item/" + focusedData.prodId + "/" + focusedData.seq,
                    data: null,
                    contentType:'application/json',
                    type: 'DELETE',
                    success: (result) => {
                        if (result > 0) {
                            alert("ÏÇ≠Ï†úÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.");
                            searchProductModalGrid();
                        } else {
                            alert("ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§.");
                            searchProductModalGrid();
                        }
                    },
                    error: (xhr, status, error) => {
                        alert(xhr.responseText);
                        searchProductModalGrid();
                    }
                })
            }
        }

        const searchProductModalGrid = () => {
            const focusedCell = productGrid.getGrid().getFocusedCell();
            const focusedData = productGrid.getGrid().getRow(focusedCell.rowKey);
            productModalGrid.load(apiUrl + "/item/list", focusedData, function(data){});
        }
        })();
    </script>

</th:block>

<!--</html>-->